import{a as J}from"./chunk-VDKSUFEH.js";import{Ab as s,Gb as B,Gc as j,Hb as f,Hc as z,Jb as v,Kb as E,Pc as U,Qa as d,Sc as Y,U as N,Ub as G,Vb as a,Wb as h,Xb as w,Yb as $,Z as S,Zb as P,a as p,ca as k,cb as V,da as C,ea as l,fa as c,jc as O,l as F,lc as A,nb as D,p as _,pa as u,pb as x,qc as g,sb as H,tb as q,yb as i,zb as o}from"./chunk-D3HV4FU7.js";var I=class r{http=S(U);today$=new F(null);getToday(){return this.today$.asObservable()}clockIn(e){let n=new Date,t=this._ensureRecord();return t.clockInTime=n.toISOString(),t.clockInLatitude=e.latitude,t.clockInLongitude=e.longitude,this.today$.next(p({},t)),_(p({},t))}clockOut(e){let n=new Date,t=this._ensureRecord();return t.clockOutTime=n.toISOString(),t.clockOutLatitude=e.latitude,t.clockOutLongitude=e.longitude,this.today$.next(p({},t)),_(p({},t))}overtimeStart(e){let n=new Date,t=this._ensureRecord();return t.overtimeStartTime=n.toISOString(),t.overtimeStartLatitude=e.latitude,t.overtimeStartLongitude=e.longitude,t.overtimeRequestId=e.overtimeRequestId,this.today$.next(p({},t)),_(p({},t))}overtimeEnd(e){let n=new Date,t=this._ensureRecord();return t.overtimeEndTime=n.toISOString(),t.overtimeEndLatitude=e.latitude,t.overtimeEndLongitude=e.longitude,this.today$.next(p({},t)),_(p({},t))}_ensureRecord(){let e=this.today$.getValue();return e||(e={id:Date.now(),userId:"1",recordDate:new Date().toISOString().split("T")[0]}),e}static \u0275fac=function(n){return new(n||r)};static \u0275prov=N({token:r,factory:r.\u0275fac,providedIn:"root"})};var Q=(r,e)=>e.id;function W(r,e){if(r&1&&(i(0,"option",47),a(1),O(2,"date"),o()),r&2){let n=e.$implicit,t=E(2);f("value",n.id)("selected",n.id===t.selectedOvertimeId()),d(),P(" ",A(2,5,n.overtimeDate,"MM/dd")," \u2014 ",(n.projectCodes==null?null:n.projectCodes.join(", "))||"\u7121\u5C08\u6848"," (",n.estimatedHours,"h) ")}}function X(r,e){if(r&1){let n=B();i(0,"div",38)(1,"label",45),a(2,"\u9078\u64C7\u52A0\u73ED\u7533\u8ACB\u55AE"),o(),i(3,"select",46),v("change",function(m){k(n);let b=E();return C(b.onOvertimeSelect(m))}),H(4,W,3,8,"option",47,Q),o(),i(6,"div",48)(7,"button",49),v("click",function(){k(n);let m=E();return C(m.confirmOvertimeStart())}),a(8,"\u78BA\u8A8D\u6253\u5361"),o(),i(9,"button",50),v("click",function(){k(n);let m=E();return C(m.cancelOvertimeSelector())}),a(10,"\u53D6\u6D88"),o()()()}if(r&2){let n=E();d(4),q(n.approvedRequests())}}function Z(r,e){r&1&&(i(0,"p",41),a(1,"\u6253\u5361\u6642\u81EA\u52D5\u53D6\u5F97 GPS \u5EA7\u6A19\u3002"),o())}function ee(r,e){r&1&&(i(0,"div",42),s(1,"div",51),i(2,"span",52),a(3,"\u5B9A\u4F4D\u4E2D\u2026"),o()())}function te(r,e){if(r&1&&(i(0,"p",56),a(1),O(2,"number"),O(3,"number"),o()),r&2){let n=E(2);d(),$(" ",A(2,2,n.gpsCoords().lat,"1.6-6"),", ",A(3,5,n.gpsCoords().lng,"1.6-6")," ")}}function ie(r,e){if(r&1&&(i(0,"div",53),l(),i(1,"svg",54),s(2,"use",30),o(),c(),i(3,"span",55),a(4,"\u5B9A\u4F4D\u6210\u529F"),o()(),D(5,te,4,8,"p",56)),r&2){let n=E();d(5),x(n.gpsCoords()?5:-1)}}function ne(r,e){r&1&&(i(0,"div",43),l(),i(1,"svg",54),s(2,"use",57),o(),c(),i(3,"span",55),a(4,"\u7121\u6CD5\u53D6\u5F97\u5B9A\u4F4D\uFF08\u6253\u5361\u4ECD\u6709\u6548\uFF09"),o()())}function oe(r,e){if(r&1&&(i(0,"div",44)(1,"div",58),a(2),o()()),r&2){let n=e;d(),G(n.type==="success"?"bg-success text-white":n.type==="warning"?"bg-warning text-dark":"bg-danger text-white"),d(),w(" ",n.message," ")}}var ae=["\u65E5","\u4E00","\u4E8C","\u4E09","\u56DB","\u4E94","\u516D"],R=class r{auth=S(Y);attendanceService=S(I);overtimeService=S(J);timerId=null;now=u(new Date);todayRecord=u(null);approvedRequests=u([]);selectedOvertimeId=u(null);showOvertimeSelector=u(!1);gpsStatus=u("idle");gpsCoords=u(null);loading=u(!1);toast=u(null);userName=g(()=>this.auth.currentUser()?.name??"\u4F7F\u7528\u8005");dateDisplay=g(()=>{let e=this.now(),n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),m=String(e.getDate()).padStart(2,"0");return`${n}/${t}/${m} \u661F\u671F${ae[e.getDay()]}`});timeDisplay=g(()=>{let e=this.now();return[e.getHours(),e.getMinutes(),e.getSeconds()].map(n=>String(n).padStart(2,"0")).join(":")});canClockIn=g(()=>!this.todayRecord()?.clockInTime&&!this.loading());canClockOut=g(()=>{let e=this.todayRecord();return!!e?.clockInTime&&!e?.clockOutTime&&!this.loading()});canOvertimeStart=g(()=>{let e=this.todayRecord();return!!e?.clockOutTime&&!e?.overtimeStartTime&&this.approvedRequests().length>0&&!this.loading()});canOvertimeEnd=g(()=>{let e=this.todayRecord();return!!e?.overtimeStartTime&&!e?.overtimeEndTime&&!this.loading()});ngOnInit(){this.timerId=setInterval(()=>this.now.set(new Date),1e3),this.attendanceService.getToday().subscribe(e=>{e&&this.todayRecord.set(e)}),this.overtimeService.getApprovedForToday().subscribe(e=>{this.approvedRequests.set(e),e.length>0&&this.selectedOvertimeId.set(e[0].id)})}ngOnDestroy(){this.timerId&&clearInterval(this.timerId)}onOvertimeSelect(e){let n=e.target.value;this.selectedOvertimeId.set(n?+n:null)}formatTime(e){if(!e)return"--:--";let n=new Date(e);return[n.getHours(),n.getMinutes()].map(t=>String(t).padStart(2,"0")).join(":")}onOvertimeStartClick(){this.approvedRequests().length!==0&&(this.selectedOvertimeId()||this.selectedOvertimeId.set(this.approvedRequests()[0].id),this.showOvertimeSelector.set(!0))}confirmOvertimeStart(){this.showOvertimeSelector.set(!1),this.performAction("overtime-start")}cancelOvertimeSelector(){this.showOvertimeSelector.set(!1)}performAction(e){this.loading()||(this.loading.set(!0),this.gpsStatus.set("locating"),this._getGps().then(n=>{this.gpsCoords.set(n),this.gpsStatus.set(n?"success":"failed");let t={latitude:n?.lat,longitude:n?.lng,overtimeRequestId:e==="overtime-start"?this.selectedOvertimeId()??void 0:void 0},m;switch(e){case"clock-in":m=this.attendanceService.clockIn(t);break;case"clock-out":m=this.attendanceService.clockOut(t);break;case"overtime-start":m=this.attendanceService.overtimeStart(t);break;case"overtime-end":m=this.attendanceService.overtimeEnd(t);break}m.subscribe({next:b=>{this.todayRecord.set(b),this.loading.set(!1);let y={"clock-in":"\u4E0A\u73ED\u6253\u5361","clock-out":"\u4E0B\u73ED\u6253\u5361","overtime-start":"\u52A0\u73ED\u958B\u59CB","overtime-end":"\u52A0\u73ED\u7D50\u675F"};this.showToast(`${y[e]}\u6210\u529F\uFF01`,n?"success":"warning")},error:()=>{this.loading.set(!1),this.showToast("\u6253\u5361\u5931\u6557\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66","error")}})}))}showToast(e,n){this.toast.set({message:e,type:n}),setTimeout(()=>this.toast.set(null),3e3)}_getGps(){return new Promise(e=>{if(!navigator.geolocation){e(null);return}navigator.geolocation.getCurrentPosition(n=>e({lat:n.coords.latitude,lng:n.coords.longitude}),()=>e(null),{enableHighAccuracy:!0,timeout:8e3,maximumAge:0})})}static \u0275fac=function(n){return new(n||r)};static \u0275cmp=V({type:r,selectors:[["app-dashboard"]],decls:100,vars:14,consts:[[1,"container-fluid","py-3"],[1,"flex","items-center","gap-3","mb-6"],[1,"sa-icon","sa-icon-2x","text-primary",2,"stroke","currentColor"],["href","/assets/icons/sprite.svg#clock"],[1,"mb-0"],[1,"text-muted","mb-0","small"],[1,"row","g-4"],[1,"col-12","col-lg-8"],[1,"card","border-0","shadow-sm","mb-4"],[1,"card-body","text-center","py-5"],[1,"text-muted","mb-2","fw-500"],[1,"mb-0","font-monospace",2,"font-size","3.5rem","font-weight","700","letter-spacing","0.05em","color","var(--text-primary)"],[1,"card-header","bg-transparent","border-bottom","flex","items-center","gap-2","fw-600"],[1,"sa-icon","text-primary",2,"stroke","currentColor"],["href","/assets/icons/sprite.svg#activity"],[1,"card-body"],[1,"row","g-3","text-center"],[1,"col-6","col-md-3"],[1,"rounded-lg","py-3",2,"background","var(--accent-dim)"],[1,"sa-icon","mb-1",2,"stroke","var(--green)"],["href","/assets/icons/sprite.svg#log-in"],[1,"text-muted","small","mb-1"],[1,"fw-600","font-monospace","mb-0"],[1,"sa-icon","mb-1",2,"stroke","var(--yellow)"],["href","/assets/icons/sprite.svg#log-out"],[1,"sa-icon","mb-1",2,"stroke","var(--purple)"],["href","/assets/icons/sprite.svg#zap"],[1,"sa-icon","mb-1",2,"stroke","var(--red)"],["href","/assets/icons/sprite.svg#zap-off"],[1,"card","border-0","shadow-sm"],["href","/assets/icons/sprite.svg#check-circle"],[1,"row","g-3"],[1,"btn","btn-primary","w-100","py-3","flex","flex-col","items-center","gap-2",3,"click","disabled"],[1,"sa-icon","sa-icon-2x",2,"stroke","currentColor"],[1,"fw-600"],[1,"btn","btn-warning","w-100","py-3","flex","flex-col","items-center","gap-2",3,"click","disabled"],[1,"btn","btn-outline-primary","w-100","py-3","flex","flex-col","items-center","gap-2",3,"click","disabled"],[1,"btn","btn-outline-secondary","w-100","py-3","flex","flex-col","items-center","gap-2",3,"click","disabled"],[1,"mt-4","pt-3","border-t"],[1,"col-12","col-lg-4"],["href","/assets/icons/sprite.svg#map-pin"],[1,"text-muted","small","mb-0"],[1,"flex","items-center","gap-2","text-muted"],[1,"flex","items-center","gap-2",2,"color","var(--yellow)"],[1,"position-fixed","bottom-0","end-0","p-4",2,"z-index","1080"],[1,"form-label","fw-600"],[1,"form-select","mb-3",3,"change"],[3,"value","selected"],[1,"flex","gap-2"],[1,"btn","btn-primary","btn-sm",3,"click"],[1,"btn","btn-outline-secondary","btn-sm",3,"click"],[1,"spinner-border","spinner-border-sm"],[1,"small"],[1,"flex","items-center","gap-2","mb-2",2,"color","var(--green)"],[1,"sa-icon",2,"stroke","currentColor"],[1,"small","fw-500"],[1,"font-monospace","small","text-muted","mb-0"],["href","/assets/icons/sprite.svg#alert-triangle"],[1,"px-4","py-3","rounded-lg","shadow-lg","fw-500"]],template:function(n,t){if(n&1&&(i(0,"div",0)(1,"div",1),l(),i(2,"svg",2),s(3,"use",3),o(),c(),i(4,"div")(5,"h4",4),a(6,"\u6253\u5361\u7CFB\u7D71"),o(),i(7,"p",5),a(8),o()()(),i(9,"div",6)(10,"div",7)(11,"div",8)(12,"div",9)(13,"p",10),a(14),o(),i(15,"p",11),a(16),o()()(),i(17,"div",8)(18,"div",12),l(),i(19,"svg",13),s(20,"use",14),o(),a(21," \u4ECA\u65E5\u6253\u5361\u7D00\u9304 "),o(),c(),i(22,"div",15)(23,"div",16)(24,"div",17)(25,"div",18),l(),i(26,"svg",19),s(27,"use",20),o(),c(),i(28,"p",21),a(29,"\u4E0A\u73ED"),o(),i(30,"p",22),a(31),o()()(),i(32,"div",17)(33,"div",18),l(),i(34,"svg",23),s(35,"use",24),o(),c(),i(36,"p",21),a(37,"\u4E0B\u73ED"),o(),i(38,"p",22),a(39),o()()(),i(40,"div",17)(41,"div",18),l(),i(42,"svg",25),s(43,"use",26),o(),c(),i(44,"p",21),a(45,"\u52A0\u73ED\u958B\u59CB"),o(),i(46,"p",22),a(47),o()()(),i(48,"div",17)(49,"div",18),l(),i(50,"svg",27),s(51,"use",28),o(),c(),i(52,"p",21),a(53,"\u52A0\u73ED\u7D50\u675F"),o(),i(54,"p",22),a(55),o()()()()()(),i(56,"div",29)(57,"div",12),l(),i(58,"svg",13),s(59,"use",30),o(),a(60," \u6253\u5361\u64CD\u4F5C "),o(),c(),i(61,"div",15)(62,"div",31)(63,"div",17)(64,"button",32),v("click",function(){return t.performAction("clock-in")}),l(),i(65,"svg",33),s(66,"use",20),o(),c(),i(67,"span",34),a(68,"\u4E0A\u73ED\u6253\u5361"),o()()(),i(69,"div",17)(70,"button",35),v("click",function(){return t.performAction("clock-out")}),l(),i(71,"svg",33),s(72,"use",24),o(),c(),i(73,"span",34),a(74,"\u4E0B\u73ED\u6253\u5361"),o()()(),i(75,"div",17)(76,"button",36),v("click",function(){return t.onOvertimeStartClick()}),l(),i(77,"svg",33),s(78,"use",26),o(),c(),i(79,"span",34),a(80,"\u52A0\u73ED\u958B\u59CB"),o()()(),i(81,"div",17)(82,"button",37),v("click",function(){return t.performAction("overtime-end")}),l(),i(83,"svg",33),s(84,"use",28),o(),c(),i(85,"span",34),a(86,"\u52A0\u73ED\u7D50\u675F"),o()()()(),D(87,X,11,0,"div",38),o()()(),i(88,"div",39)(89,"div",29)(90,"div",12),l(),i(91,"svg",13),s(92,"use",40),o(),a(93," \u5B9A\u4F4D\u8CC7\u8A0A "),o(),c(),i(94,"div",15),D(95,Z,2,0,"p",41)(96,ee,4,0,"div",42)(97,ie,6,1)(98,ne,5,0,"div",43),o()()()(),D(99,oe,3,3,"div",44),o()),n&2){let m,b,y,M,T,L;d(8),w("",t.userName(),"\uFF0C\u6B61\u8FCE\u56DE\u4F86"),d(6),h(t.dateDisplay()),d(2),w(" ",t.timeDisplay()," "),d(15),h(t.formatTime((m=t.todayRecord())==null?null:m.clockInTime)),d(8),h(t.formatTime((b=t.todayRecord())==null?null:b.clockOutTime)),d(8),h(t.formatTime((y=t.todayRecord())==null?null:y.overtimeStartTime)),d(8),h(t.formatTime((M=t.todayRecord())==null?null:M.overtimeEndTime)),d(9),f("disabled",!t.canClockIn()),d(6),f("disabled",!t.canClockOut()),d(6),f("disabled",!t.canOvertimeStart()),d(6),f("disabled",!t.canOvertimeEnd()),d(5),x(t.showOvertimeSelector()?87:-1),d(8),x((T=t.gpsStatus())==="idle"?95:T==="locating"?96:T==="success"?97:T==="failed"?98:-1),d(4),x((L=t.toast())?99:-1,L)}},dependencies:[j,z],encapsulation:2,changeDetection:0})};var Te=[{path:"",component:R,data:{title:"Dashboard"}}];export{Te as DASHBOARD_ROUTES};
