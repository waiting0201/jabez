<div class="container-fluid py-3">
  @if (task$ | async; as task) {

    <!-- Page Header -->
    <div class="flex items-center gap-2 mb-6">
      <a routerLink="/admin/approval-tasks" class="btn btn-sm btn-outline-secondary">
        <svg class="sa-icon"><use href="/assets/icons/sprite.svg#arrow-left"></use></svg>
      </a>
      <svg class="sa-icon sa-icon-2x text-primary" style="stroke: currentColor">
        <use href="/assets/icons/sprite.svg#check-square"></use>
      </svg>
      <h4 class="mb-0">簽核審核</h4>
      <span [class]="'badge ' + appTypeClass[task.applicationType]">{{ appTypeLabel[task.applicationType] }}</span>
      <span [class]="'badge ' + statusClass[task.status]">{{ statusLabel[task.status] }}</span>
    </div>

    @if (errorMsg()) {
      <div class="alert alert-danger flex items-center gap-2 mb-6 py-2" role="alert">
        <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#alert-triangle"></use></svg>
        {{ errorMsg() }}
      </div>
    }

    <div class="row g-4">
      <div class="col-12 col-lg-10 col-xl-8">

        <!-- ── 申請資訊（依類型切換）────────────────────────────── -->
        @switch (task.applicationType) {

          @case ('payment_request') {
            @if (task.paymentDetail; as d) {
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
                  <svg class="sa-icon text-primary" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#dollar-sign"></use></svg>
                  請款申請資訊
                </div>
                <div class="card-body">
                  <div class="row g-3 mb-0">
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">請款類型</div>
                      <span class="fw-500">{{ payTypeLabel[d.paymentType] }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">專案編號</div>
                      <span class="fw-500 font-monospace">{{ d.projectCode }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">申請人</div>
                      <span class="fw-500">{{ task.submittedBy }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">申請時間</div>
                      <span class="text-muted small">{{ task.submittedAt | date:'yyyy-MM-dd' }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">總金額</div>
                      <span class="fw-600 fs-5">{{ d.totalAmount | number:'1.0-0' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 發票明細 -->
              <div class="card border-0 shadow-sm mt-6">
                <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
                  <svg class="sa-icon text-primary" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#file-text"></use></svg>
                  發票明細
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>檔案名稱</th>
                          <th>發票號碼</th>
                          <th class="text-right">金額</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (inv of d.invoices; track inv.id) {
                          <tr>
                            <td class="small" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                              @if (inv.previewUrl) {
                                <button type="button"
                                        class="btn btn-link p-0 text-muted small inline-flex items-center gap-1"
                                        style="text-decoration:none;max-width:100%;overflow:hidden;text-overflow:ellipsis"
                                        (click)="openPreview(inv.fileName, inv.previewUrl)">
                                  <svg class="sa-icon shrink-0" style="width:14px;height:14px;stroke:currentColor">
                                    <use href="/assets/icons/sprite.svg#file-text"></use>
                                  </svg>
                                  {{ inv.fileName }}
                                </button>
                              } @else {
                                <span class="text-muted inline-flex items-center gap-1">
                                  <svg class="sa-icon shrink-0" style="width:14px;height:14px;stroke:currentColor">
                                    <use href="/assets/icons/sprite.svg#file-text"></use>
                                  </svg>
                                  {{ inv.fileName }}
                                </span>
                              }
                            </td>
                            <td class="font-monospace small">{{ inv.invoiceNo }}</td>
                            <td class="text-right fw-500">{{ inv.amount | number:'1.0-0' }}</td>
                          </tr>
                        }
                      </tbody>
                      <tfoot>
                        <tr class="table-light">
                          <td colspan="2" class="text-right fw-500 small">合計</td>
                          <td class="text-right fw-600">{{ d.totalAmount | number:'1.0-0' }}</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
            }
          }

          @case ('leave') {
            @if (task.leaveDetail; as d) {
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
                  <svg class="sa-icon text-primary" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#calendar"></use></svg>
                  請假申請資訊
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">假別</div>
                      <span class="fw-500">{{ leaveTypeLabel[d.leaveType] }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">申請人</div>
                      <span class="fw-500">{{ task.submittedBy }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">天數</div>
                      <span class="fw-600 fs-5">{{ d.days }} 天</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">開始日期</div>
                      <span class="text-muted small">{{ d.startDate | date:'yyyy-MM-dd' }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">結束日期</div>
                      <span class="text-muted small">{{ d.endDate | date:'yyyy-MM-dd' }}</span>
                    </div>
                    <div class="col-12">
                      <div class="text-muted small mb-1">請假原因</div>
                      <div class="border rounded p-4 bg-[--bg-base] small">{{ d.reason }}</div>
                    </div>
                  </div>
                </div>
              </div>
            }
          }

          @case ('travel') {
            @if (task.travelDetail; as d) {
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
                  <svg class="sa-icon text-primary" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#map-pin"></use></svg>
                  出差申請資訊
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">出差地點</div>
                      <span class="fw-500">{{ d.destination }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">申請人</div>
                      <span class="fw-500">{{ task.submittedBy }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">預估費用</div>
                      <span class="fw-600 fs-5">{{ d.estimatedCost | number:'1.0-0' }} 元</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">出發日期</div>
                      <span class="text-muted small">{{ d.startDate | date:'yyyy-MM-dd' }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">返回日期</div>
                      <span class="text-muted small">{{ d.endDate | date:'yyyy-MM-dd' }}</span>
                    </div>
                    @if (d.projectCode) {
                      <div class="col-6 col-md-4">
                        <div class="text-muted small mb-1">關聯專案</div>
                        <span class="font-monospace fw-500">{{ d.projectCode }}</span>
                      </div>
                    }
                    <div class="col-12">
                      <div class="text-muted small mb-1">出差目的</div>
                      <div class="border rounded p-4 bg-[--bg-base] small">{{ d.purpose }}</div>
                    </div>
                  </div>
                </div>
              </div>
            }
          }

          @case ('overtime') {
            @if (task.overtimeDetail; as d) {
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
                  <svg class="sa-icon text-primary" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#clock"></use></svg>
                  加班申請資訊
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">加班日期</div>
                      <span class="fw-500">{{ d.overtimeDate | date:'yyyy-MM-dd' }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">申請人</div>
                      <span class="fw-500">{{ task.submittedBy }}</span>
                    </div>
                    <div class="col-6 col-md-4">
                      <div class="text-muted small mb-1">預計加班時數</div>
                      <span class="fw-600 fs-5">{{ d.estimatedHours }} 小時</span>
                    </div>
                    @if (d.projectCodes && d.projectCodes.length > 0) {
                      <div class="col-12 col-md-8">
                        <div class="text-muted small mb-1">關聯專案</div>
                        <div class="flex flex-wrap gap-1">
                          @for (code of d.projectCodes; track code) {
                            <span class="badge bg-[--bg-base] text-[--text-muted] font-monospace">{{ code }}</span>
                          }
                        </div>
                      </div>
                    }
                    <div class="col-12">
                      <div class="text-muted small mb-1">加班原因</div>
                      <div class="border rounded p-4 bg-[--bg-base] small">{{ d.reason }}</div>
                    </div>
                  </div>
                </div>
              </div>
            }
          }

        }

        <!-- ── 簽核流程時間軸 ────────────────────────────────────── -->
        @if (task.flow) {
          <div class="card border-0 shadow-sm mt-6">
            <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
              <svg class="sa-icon text-primary" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#git-merge"></use></svg>
              簽核流程
            </div>
            <div class="card-body">
              <ol class="list-none p-0 mb-0">
                @for (step of task.flow.steps; track step.stepOrder; let last = $last) {
                  <li class="flex items-start gap-3" [class.mb-6]="!last">
                    <!-- 步驟圓圈 -->
                    @if (getRecord(task.approvalRecords, step.stepOrder); as rec) {
                      @if (rec.action === 'approved') {
                        <span class="badge bg-success rounded-circle flex items-center justify-center shrink-0"
                              style="width:28px;height:28px;min-width:28px;font-size:.85rem">✓</span>
                      } @else {
                        <span class="badge bg-danger rounded-circle flex items-center justify-center shrink-0"
                              style="width:28px;height:28px;min-width:28px;font-size:.85rem">✗</span>
                      }
                    } @else if (task.currentStepOrder === step.stepOrder && task.status === 'pending') {
                      <span class="badge bg-primary rounded-circle flex items-center justify-center shrink-0"
                            style="width:28px;height:28px;min-width:28px;font-size:.75rem">{{ step.stepOrder }}</span>
                    } @else {
                      <span class="badge bg-[--bg-base] text-[--text-muted] rounded-circle flex items-center justify-center shrink-0"
                            style="width:28px;height:28px;min-width:28px;font-size:.75rem">{{ step.stepOrder }}</span>
                    }
                    <!-- 步驟內容 -->
                    <div class="grow">
                      <div class="fw-500">
                        {{ step.jobTitleName || '—' }}
                        @if (step.departmentName) {
                          <span class="text-muted font-normal">（{{ step.departmentName }}）</span>
                        }
                      </div>
                      @if (step.note) {
                        <div class="text-muted small">{{ step.note }}</div>
                      }
                      @if (getRecord(task.approvalRecords, step.stepOrder); as rec) {
                        <div class="text-muted small mt-1">
                          {{ rec.reviewedBy }} · {{ rec.reviewedAt | date:'yyyy-MM-dd' }} ·
                          @if (rec.action === 'approved') {
                            <span class="text-success">已核准</span>
                          } @else if (rec.action === 'returned') {
                            <span class="text-[--yellow]">退回修改</span>
                          } @else {
                            <span class="text-danger">已拒絕</span>
                          }
                        </div>
                        @if (rec.reviewNote) {
                          <div class="text-muted small italic mt-1">「{{ rec.reviewNote }}」</div>
                        }
                      } @else if (task.currentStepOrder === step.stepOrder && task.status === 'pending') {
                        <div class="text-primary small mt-1">審核中…</div>
                      }
                    </div>
                  </li>
                }
              </ol>
            </div>
          </div>
        }

        <!-- ── 審核區塊 ──────────────────────────────────────────── -->
        @if (task.status === 'pending') {
          <div class="card border-0 shadow-sm mt-6">
            <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
              <svg class="sa-icon text-primary" style="stroke: currentColor">
                <use href="/assets/icons/sprite.svg#check-square"></use>
              </svg>
              審核
            </div>
            <div class="card-body">
              <form [formGroup]="form" (ngSubmit)="submit()">
                <div class="mb-4">
                  <label class="form-label fw-500">審核結果 <span class="text-danger">*</span></label>
                  <div class="flex flex-wrap gap-4 mt-1">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" formControlName="action" value="approved" id="actionApprove">
                      <label class="form-check-label fw-500 text-success" for="actionApprove">核准</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" formControlName="action" value="returned" id="actionReturn">
                      <label class="form-check-label fw-500 text-[--yellow]" for="actionReturn">退回修改</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" formControlName="action" value="rejected" id="actionReject">
                      <label class="form-check-label fw-500 text-danger" for="actionReject">拒絕（終止）</label>
                    </div>
                  </div>
                </div>
                <div class="mb-4">
                  <label class="form-label fw-500">
                    審核意見
                    @if (form.get('action')?.value === 'rejected' || form.get('action')?.value === 'returned') {
                      <span class="text-danger">*</span>
                    }
                  </label>
                  <textarea class="form-control" formControlName="reviewNote" rows="3"
                            placeholder="填寫審核意見（退回修改或拒絕時必填）..."></textarea>
                  @if (showNoteError) {
                    <div class="text-danger small mt-1">退回修改或拒絕時請填寫原因。</div>
                  }
                </div>
                <div class="flex gap-2">
                  <button type="submit" class="btn btn-primary">提交審核</button>
                  <a routerLink="/admin/approval-tasks" class="btn btn-outline-secondary">取消</a>
                </div>
              </form>
            </div>
          </div>
        } @else if (task.status === 'returned') {
          <!-- 退回修改 -->
          <div class="card border-0 shadow-sm mt-6">
            <div class="card-header bg-[rgba(184,137,42,0.08)] border-bottom flex items-center gap-2 fw-600 text-[--yellow]">
              <svg class="sa-icon" style="stroke: currentColor">
                <use href="/assets/icons/sprite.svg#rotate-ccw"></use>
              </svg>
              退回修改
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">此申請已退回，待申請人修改後重新送出。</p>
              @if (task.reviewNote) {
                <div class="text-muted small mb-1 fw-500">退回原因：</div>
                <div class="border rounded p-4 bg-[--bg-base] small mb-4">{{ task.reviewNote }}</div>
              }
              <div class="mt-2">
                <a routerLink="/admin/approval-tasks" class="btn btn-outline-secondary">返回列表</a>
              </div>
            </div>
          </div>
        } @else if (task.status === 'approved') {
          <!-- 已核准 -->
          <div class="card border-0 shadow-sm mt-6">
            <div class="card-header bg-[rgba(37,162,68,0.08)] border-bottom flex items-center gap-2 fw-600 text-success">
              <svg class="sa-icon" style="stroke: currentColor">
                <use href="/assets/icons/sprite.svg#check-circle"></use>
              </svg>
              已核准
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">此申請已通過所有簽核流程，不可再修改。</p>
              @if (task.reviewedAt) {
                <div class="text-muted small mb-1 fw-500">核准時間：</div>
                <div class="small mb-4">{{ task.reviewedAt | date:'yyyy-MM-dd HH:mm' }}</div>
              }
              @if (task.reviewNote) {
                <div class="text-muted small mb-1 fw-500">審核意見：</div>
                <div class="border rounded p-4 bg-[--bg-base] small mb-4">{{ task.reviewNote }}</div>
              }
              <div class="mt-2">
                <a routerLink="/admin/approval-tasks" class="btn btn-outline-secondary">返回列表</a>
              </div>
            </div>
          </div>
        } @else {
          <!-- 已拒絕 -->
          <div class="card border-0 shadow-sm mt-6">
            <div class="card-header bg-[rgba(220,53,69,0.08)] border-bottom flex items-center gap-2 fw-600 text-danger">
              <svg class="sa-icon" style="stroke: currentColor">
                <use href="/assets/icons/sprite.svg#x-circle"></use>
              </svg>
              已拒絕
            </div>
            <div class="card-body">
              <p class="text-muted small mb-2">此申請已被拒絕，簽核流程終止，不可再修改。</p>
              @if (task.reviewedAt) {
                <div class="text-muted small mb-1 fw-500">拒絕時間：</div>
                <div class="small mb-4">{{ task.reviewedAt | date:'yyyy-MM-dd HH:mm' }}</div>
              }
              @if (task.reviewNote) {
                <div class="text-muted small mb-1 fw-500">拒絕原因：</div>
                <div class="border rounded p-4 bg-[--bg-base] small mb-4">{{ task.reviewNote }}</div>
              }
              <div class="mt-2">
                <a routerLink="/admin/approval-tasks" class="btn btn-outline-secondary">返回列表</a>
              </div>
            </div>
          </div>
        }

      </div>
    </div>

  } @else {
    <p class="text-muted">找不到此簽核作業。</p>
  }
</div>

@if (previewFile) {
  <app-file-preview-modal [file]="previewFile" (closed)="closePreview()" />
}
