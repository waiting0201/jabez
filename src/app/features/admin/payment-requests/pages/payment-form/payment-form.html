<div class="container-fluid py-3">
  <div class="flex items-center gap-2 mb-6">
    <a routerLink="/admin/payment-requests" class="btn btn-sm btn-outline-secondary">
      <svg class="sa-icon"><use href="/assets/icons/sprite.svg#arrow-left"></use></svg>
    </a>
    <h4 class="mb-0">{{ isEdit ? (isReadOnly ? '檢視請款申請' : '編輯請款草稿') : '新增請款申請' }}</h4>
  </div>

  @if (errorMsg()) {
    <div class="alert alert-danger flex items-center gap-2 mb-6 py-2" role="alert">
      <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#alert-triangle"></use></svg>
      {{ errorMsg() }}
    </div>
  }

  @if (isReadOnly && approvalStatus === 'pending') {
    <div class="card border-0 shadow-sm mb-6">
      <div class="card-header bg-[rgba(13,110,253,0.08)] border-bottom flex items-center gap-2 fw-600 text-primary py-3">
        <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#clock"></use></svg>
        此申請審核中，不可再修改。
      </div>
    </div>
  } @else if (isReadOnly && approvalStatus === 'returned') {
    <div class="card border-0 shadow-sm mb-6">
      <div class="card-header bg-[rgba(255,193,7,0.08)] border-bottom flex items-center gap-2 fw-600 text-warning py-3">
        <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#alert-triangle"></use></svg>
        此申請已被退回，不可再修改。
      </div>
    </div>
  } @else if (isReadOnly && approvalStatus === 'approved') {
    <div class="card border-0 shadow-sm mb-6">
      <div class="card-header bg-[rgba(37,162,68,0.08)] border-bottom flex items-center gap-2 fw-600 text-success py-3">
        <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#check-circle"></use></svg>
        此申請已核准，不可再修改。
      </div>
    </div>
  } @else if (isReadOnly && approvalStatus === 'rejected') {
    <div class="card border-0 shadow-sm mb-6">
      <div class="card-header bg-[rgba(220,53,69,0.08)] border-bottom flex items-center gap-2 fw-600 text-danger py-3">
        <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#x-circle"></use></svg>
        此申請已被拒絕，不可再修改。
      </div>
    </div>
  }

  <form [formGroup]="form" (ngSubmit)="save()">
    <div class="row g-4">
      <div class="col-12 col-lg-10 col-xl-8">

        <!-- 基本資訊 -->
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
            <svg class="sa-icon text-primary" style="stroke: currentColor">
              <use href="/assets/icons/sprite.svg#dollar-sign"></use>
            </svg>
            基本資訊
          </div>
          <div class="card-body">

            <div class="mb-4">
              <label class="form-label fw-500">請款類型 <span class="text-danger">*</span></label>
              <div class="flex flex-wrap gap-4 mt-1">
                <div class="form-check">
                  <input class="form-check-input" type="radio" formControlName="type" value="vendor" id="typeVendor">
                  <label class="form-check-label" for="typeVendor">廠商請款</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" formControlName="type" value="travel" id="typeTravel">
                  <label class="form-check-label" for="typeTravel">員工差旅</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" formControlName="type" value="advance" id="typeAdvance">
                  <label class="form-check-label" for="typeAdvance">員工預支</label>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-500">專案 <span class="text-danger">*</span></label>
              @if (isReadOnly) {
                <p class="form-control-plaintext fw-500 font-monospace mb-0">{{ projectCode || '—' }}</p>
              } @else {
                <select class="form-select" formControlName="projectId">
                  <option [ngValue]="null">{{ loadingProjects ? '載入中…' : '— 請選擇專案 —' }}</option>
                  @for (p of projects; track p.id) {
                    <option [ngValue]="p.id">{{ p.code }}{{ p.departmentName ? '（' + p.departmentName + '）' : '' }}</option>
                  }
                </select>
                @if (form.get('projectId')?.invalid && form.get('projectId')?.touched) {
                  <div class="text-danger small mt-1">請選擇專案。</div>
                }
              }
            </div>

            @if (isEdit) {
              <div class="mb-0">
                <label class="form-label fw-500">簽核狀態</label>
                <div>
                  <span class="badge rounded-pill px-3 py-2" [class]="statusClass[approvalStatus]">
                    {{ statusLabel[approvalStatus] }}
                  </span>
                </div>
              </div>
            }

          </div>
        </div>

        <!-- 發票 -->
        <div class="card border-0 shadow-sm mt-6">
          <div class="card-header bg-transparent border-bottom flex items-center gap-2 fw-600">
            <svg class="sa-icon text-primary" style="stroke: currentColor">
              <use href="/assets/icons/sprite.svg#file-text"></use>
            </svg>
            發票
          </div>
          <div class="card-body">

            @if (!isReadOnly) {
              <!-- Upload area -->
              <label class="flex flex-col items-center justify-center rounded-3 py-4 px-4 mb-4 text-center"
                     style="cursor:pointer; border: 2px dashed var(--bs-border-color);">
                <svg class="sa-icon sa-icon-2x text-muted mb-2" style="stroke: currentColor">
                  <use href="/assets/icons/sprite.svg#upload"></use>
                </svg>
                <span class="fw-500">點擊上傳發票圖檔</span>
                <span class="text-muted small mt-1">支援 JPG、PNG、PDF，可多選</span>
                <input type="file" class="hidden" multiple accept="image/*,application/pdf"
                       (change)="onFilesSelected($event)">
              </label>

              @if (showInvoiceError) {
                <div class="alert alert-warning py-2 small mb-4">請至少上傳一張發票。</div>
              }
            }

            <!-- Invoice table -->
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead class="table-light">
                  <tr>
                    <th>檔案名稱</th>
                    <th style="min-width:160px">發票號碼</th>
                    <th style="min-width:120px">金額</th>
                    @if (!isReadOnly) {
                      <th style="width:48px"></th>
                    }
                  </tr>
                </thead>
                <tbody formArrayName="invoices">
                  @for (ctrl of invoiceControls; track ctrl.get('id')?.value; let i = $index) {
                    @let isOcr = ocrLoadingIds.has(ctrl.get('id')?.value);
                    <tr [formGroupName]="i">
                      <td class="align-middle small"
                          style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                        @if (ctrl.get('previewUrl')?.value || ctrl.get('fileUrl')?.value) {
                          <button type="button"
                                  class="btn btn-link p-0 text-muted small inline-flex items-center gap-1"
                                  style="text-decoration:none;max-width:100%;overflow:hidden;text-overflow:ellipsis"
                                  (click)="openPreview(ctrl.get('fileName')?.value, ctrl.get('previewUrl')?.value || ctrl.get('fileUrl')?.value)">
                            <svg class="sa-icon shrink-0" style="width:14px;height:14px;stroke:currentColor">
                              <use href="/assets/icons/sprite.svg#file-text"></use>
                            </svg>
                            {{ ctrl.get('fileName')?.value }}
                          </button>
                        } @else {
                          <span class="text-muted inline-flex items-center gap-1">
                            <svg class="sa-icon shrink-0" style="width:14px;height:14px;stroke:currentColor">
                              <use href="/assets/icons/sprite.svg#file-text"></use>
                            </svg>
                            {{ ctrl.get('fileName')?.value }}
                          </span>
                        }
                      </td>
                      <td class="align-middle">
                        @if (isReadOnly) {
                          <span class="font-monospace small">{{ ctrl.get('invoiceNo')?.value || '—' }}</span>
                        } @else if (isOcr) {
                          <div class="flex items-center gap-2 text-muted small py-1">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            識別中…
                          </div>
                        } @else {
                          <input class="form-control form-control-sm font-monospace"
                                 formControlName="invoiceNo" placeholder="AB12345678">
                        }
                      </td>
                      <td class="align-middle">
                        @if (isReadOnly) {
                          <span class="small">{{ ctrl.get('amount')?.value | number:'1.0-0' }}</span>
                        } @else if (isOcr) {
                          <div class="py-1">—</div>
                        } @else {
                          <input type="number" class="form-control form-control-sm"
                                 formControlName="amount" min="0" placeholder="0">
                        }
                      </td>
                      @if (!isReadOnly) {
                        <td class="text-right align-middle">
                          <button type="button"
                                  class="btn btn-sm btn-ghost-danger inline-flex items-center"
                                  [disabled]="isOcr"
                                  (click)="removeInvoice(i)">
                            <svg class="sa-icon" style="stroke:currentColor"><use href="/assets/icons/sprite.svg#x"></use></svg>
                          </button>
                        </td>
                      }
                    </tr>
                  } @empty {
                    <tr>
                      <td [attr.colspan]="isReadOnly ? 3 : 4" class="text-center text-muted py-4 small">尚未新增發票</td>
                    </tr>
                  }
                </tbody>
                @if (invoiceControls.length > 0) {
                  <tfoot>
                    <tr class="table-light">
                      <td colspan="2" class="text-right fw-500 small">合計</td>
                      <td class="fw-600">{{ totalAmount | number:'1.0-0' }}</td>
                      @if (!isReadOnly) {
                        <td></td>
                      }
                    </tr>
                  </tfoot>
                }
              </table>
            </div>

          </div>
        </div>

        <!-- Submit / Back -->
        @if (!isReadOnly) {
          <div class="mt-6 flex gap-2">
            <button type="submit" class="btn btn-outline-secondary" [disabled]="form.invalid || isAnyOcrPending">
              @if (isAnyOcrPending) {
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              }
              {{ isEdit ? '儲存' : '儲存草稿' }}
            </button>
            <button type="button" class="btn btn-primary" [disabled]="form.invalid || isAnyOcrPending"
                    (click)="submitForApproval()">
              送出申請
            </button>
            <a routerLink="/admin/payment-requests" class="btn btn-outline-secondary">取消</a>
          </div>
        } @else {
          <div class="mt-6">
            <a routerLink="/admin/payment-requests" class="btn btn-outline-secondary">返回列表</a>
          </div>
        }

      </div>
    </div>
  </form>
</div>

@if (previewFile) {
  <app-file-preview-modal [file]="previewFile" (closed)="closePreview()" />
}
