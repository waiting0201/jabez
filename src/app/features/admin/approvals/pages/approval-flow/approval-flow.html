<div class="container-fluid py-3">
  @if (item$ | async; as item) {
    <!-- Page Header -->
    <div class="flex flex-wrap items-center justify-between gap-2 mb-6">
      <div class="flex items-center gap-2">
        <a routerLink="/admin/approvals" class="btn btn-sm btn-outline-secondary">
          <svg class="sa-icon"><use href="/assets/icons/sprite.svg#arrow-left"></use></svg>
        </a>
        <svg class="sa-icon sa-icon-2x text-primary" style="stroke: currentColor">
          <use href="/assets/icons/sprite.svg#git-merge"></use>
        </svg>
        <h4 class="mb-0">{{ item.name }}｜簽核流程</h4>
        <span [class]="'badge ' + (item.isActive ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary')">
          {{ item.isActive ? '啟用' : '停用' }}
        </span>
      </div>
    </div>
    @if (errorMsg()) {
      <div class="alert alert-danger flex items-center gap-2 mb-6 py-2" role="alert">
        <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#alert-triangle"></use></svg>
        {{ errorMsg() }}
      </div>
    }
    @if (item.description) {
      <p class="text-muted small mb-6">{{ item.description }}</p>
    }

    <!-- Steps Timeline -->
    <div class="flex items-center justify-between mb-4">
      <h6 class="mb-0 text-muted">簽核步驟（共 {{ item.steps.length }} 步）</h6>
      <button class="btn btn-outline-primary btn-sm inline-flex items-center gap-1" (click)="openAddStep()">
        <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#plus"></use></svg>
        新增步驟
      </button>
    </div>

    <!-- Step Form -->
    @if (showStepForm) {
      <div class="card border-0 shadow-sm mb-6">
        <div class="card-header bg-transparent fw-500">
          {{ editStep ? '編輯步驟' : '新增步驟' }}
        </div>
        <div class="card-body">
          <form [formGroup]="stepForm" (ngSubmit)="submitStep()">
            <div class="row g-3">
              <div class="col-6 col-md-2">
                <label class="form-label fw-500">步驟順序 <span class="text-danger">*</span></label>
                <input type="number" class="form-control" formControlName="stepOrder" min="1">
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-500">部門</label>
                <select class="form-select" formControlName="departmentId">
                  <option [ngValue]="null">— 不限部門 —</option>
                  @for (dept of departments; track dept.id) {
                    <option [ngValue]="dept.id">{{ dept.name }}</option>
                  }
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-500">職稱</label>
                <select class="form-select" formControlName="jobTitleId">
                  <option [ngValue]="null">— 不限職稱 —</option>
                  @for (jt of jobTitles; track jt.id) {
                    <option [ngValue]="jt.id">{{ jt.name }}（L{{ jt.level }}）</option>
                  }
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-500">步驟說明</label>
                <input type="text" class="form-control" formControlName="note" placeholder="選填說明">
              </div>
            </div>
            <div class="text-muted small mt-2">部門或職稱至少選一。</div>
            <div class="flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary btn-sm">
                {{ editStep ? '更新' : '新增' }}
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm"
                      (click)="closeStepForm()">取消</button>
            </div>
          </form>
        </div>
      </div>
    }

    @if (item.steps.length === 0) {
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center text-muted py-5">尚未設定任何步驟</div>
      </div>
    } @else {
      <div class="flex flex-col gap-2">
        @for (step of item.steps; track step.id; let last = $last) {
          <div class="flex gap-3 items-center">
            <!-- Step number bubble -->
            <div class="flex flex-col items-center shrink-0" style="width:36px">
              <div class="rounded-circle bg-primary text-white flex items-center justify-center font-bold"
                   style="width:32px;height:32px;font-size:.85rem">
                {{ step.stepOrder }}
              </div>
            </div>
            <!-- Step card -->
            <div class="card border-0 shadow-sm grow min-w-0 mb-0">
              <div class="card-body py-2 px-3">
                <div class="flex items-center justify-between flex-wrap gap-2">
                  <div class="flex flex-wrap gap-2 items-center">
                    @if (step.departmentName) {
                      <span class="badge bg-primary-subtle text-primary inline-flex items-center gap-1" style="white-space:nowrap">
                        <svg class="sa-icon" style="width:12px;height:12px;flex-shrink:0;stroke:currentColor"><use href="/assets/icons/sprite.svg#git-branch"></use></svg>
                        {{ step.departmentName }}
                      </span>
                    }
                    @if (step.jobTitleName) {
                      <span class="badge bg-warning-subtle text-warning-emphasis inline-flex items-center gap-1" style="white-space:nowrap">
                        <svg class="sa-icon" style="width:12px;height:12px;flex-shrink:0;stroke:currentColor"><use href="/assets/icons/sprite.svg#briefcase"></use></svg>
                        {{ step.jobTitleName }}
                      </span>
                    }
                    @if (step.note) {
                      <span class="text-muted small">{{ step.note }}</span>
                    }
                  </div>
                  <div class="flex gap-1">
                    <button class="btn btn-sm btn-ghost-primary inline-flex items-center"
                            (click)="openEditStep(step)" title="編輯">
                      <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#edit"></use></svg>
                    </button>
                    <button class="btn btn-sm btn-ghost-danger inline-flex items-center"
                            (click)="deleteStep(step)" title="刪除">
                      <svg class="sa-icon" style="stroke: currentColor"><use href="/assets/icons/sprite.svg#trash"></use></svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }
  } @else {
    <p class="text-muted">找不到簽核項目。</p>
  }
</div>
